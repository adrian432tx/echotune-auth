<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="referrer" content="origin-when-cross-origin">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>EchoTune - Connect Apple Music</title>
    <script src="https://js-cdn.music.apple.com/musickit/v1/musickit.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            color: #fff;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            padding-bottom: env(safe-area-inset-bottom, 40px);
        }

        .container {
            max-width: 340px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo-container {
            margin-bottom: 24px;
        }

        .echotune-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00D4AA 0%, #00B894 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            box-shadow: 0 8px 32px rgba(0, 212, 170, 0.3);
        }

        .echotune-logo svg {
            width: 48px;
            height: 48px;
            fill: white;
        }

        .app-name {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #00D4AA 0%, #00E5B8 50%, #00B894 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            font-size: 22px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 15px;
            color: #888;
            margin-bottom: 32px;
            line-height: 1.4;
        }

        .apple-music-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 20px;
            padding: 8px 16px;
            margin-bottom: 28px;
        }

        .apple-music-badge svg {
            width: 18px;
            height: 18px;
        }

        .apple-music-badge span {
            font-size: 14px;
            color: #e0e0e0;
            font-weight: 500;
        }

        .btn {
            background: linear-gradient(135deg, #FA233B 0%, #fb4d61 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 17px;
            font-weight: 600;
            border-radius: 28px;
            cursor: pointer;
            width: 100%;
            max-width: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
            box-shadow: 0 6px 20px rgba(250, 35, 59, 0.35);
            margin: 0 auto;
        }

        .btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .btn svg {
            width: 22px;
            height: 22px;
            fill: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .security-note {
            margin-top: 20px;
            font-size: 13px;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .error {
            color: #ff3b30;
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.2);
            border-radius: 12px;
            padding: 14px;
            margin-top: 20px;
            font-size: 14px;
            width: 100%;
        }

        .loading {
            display: none;
            margin-top: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 28px;
            height: 28px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #00D4AA;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <!-- EchoTune Bat Logo -->
            <div class="echotune-logo">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 15 C35 15 25 25 20 35 C15 45 10 55 5 65 C15 60 25 58 35 60 C40 45 45 35 50 30 C55 35 60 45 65 60 C75 58 85 60 95 65 C90 55 85 45 80 35 C75 25 65 15 50 15 Z M50 50 C45 50 42 55 42 60 C42 65 45 70 50 70 C55 70 58 65 58 60 C58 55 55 50 50 50 Z"/>
                </svg>
            </div>
            <div class="app-name">EchoTune</div>
        </div>

        <h2>Connect Apple Music</h2>
        <p class="subtitle">Sign in to discover YouTube videos for your favorite music</p>

        <div class="apple-music-badge">
            <!-- Music Note Icon -->
            <svg viewBox="0 0 24 24" fill="#FA233B">
                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
            </svg>
            <span>Apple Music</span>
        </div>

        <button id="login-btn" class="btn">
            <!-- Apple Logo -->
            <svg viewBox="0 0 24 24">
                <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
            </svg>
            Sign In
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
        </div>

        <div id="error-container"></div>

        <div class="security-note">
            ðŸ”’ Secure Apple Authentication
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const devToken = urlParams.get('token');
        const callbackScheme = "echotune";
        const loginBtn = document.getElementById('login-btn');
        const errorContainer = document.getElementById('error-container');
        const loading = document.getElementById('loading');

        if (!devToken) {
            errorContainer.innerHTML = '<div class="error">Error: Missing Developer Token. Please try again from the app.</div>';
            loginBtn.style.display = 'none';
        }

        document.addEventListener('musickitloaded', async function() {
            if (!devToken) return;
            try {
                await MusicKit.configure({
                    developerToken: devToken,
                    app: {
                        name: 'EchoTune',
                        build: '1.0.0'
                    }
                });
                const music = MusicKit.getInstance();

                loginBtn.addEventListener('click', async () => {
                    try {
                        loginBtn.disabled = true;
                        loading.classList.add('active');
                        errorContainer.innerHTML = '';

                        const userToken = await music.authorize();
                        window.location.href = callbackScheme + '://auth-callback?userToken=' + encodeURIComponent(userToken);
                    } catch (err) {
                        loginBtn.disabled = false;
                        loading.classList.remove('active');
                        errorContainer.innerHTML = '<div class="error">Authentication failed: ' + err.message + '</div>';
                    }
                });
            } catch (err) {
                errorContainer.innerHTML = '<div class="error">Configuration error: ' + err.message + '</div>';
                loginBtn.style.display = 'none';
            }
        });
    </script>
</body>
</html>
